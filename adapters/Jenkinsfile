pipeline {
    agent any
    stages {
        stage('Offload Scan') {
            steps {
                script {
                    // 0. App is assumed running on AI_BRAIN_URL

                    // 1. Zip
                    sh "zip -r source_code.zip . -x '.git/*'"

                    // 2. Upload
                    sh """
                        echo "üöÄ Uploading source code to AI Agent..."
                        curl -s -X POST ${AI_BRAIN_URL}/scan/upload \
                            -H "X-API-Key: ${AI_API_KEY}" \
                            -F "project=${JOB_NAME}" \
                            -F "branch=${BRANCH_NAME}" \
                            -F "commit_sha=${GIT_COMMIT}" \
                            -F "ci_provider=jenkins" \
                            -F "repo_url=${GIT_URL}" \
                            -F "run_url=${BUILD_URL}" \
                            -F "file=@source_code.zip" > scan_response.json
                        
                        echo "=== SCAN RESPONSE ==="
                        cat scan_response.json
                    """
                    archiveArtifacts artifacts: 'scan_response.json', allowEmptyArchive: true
                }
            }
        }
        
        stage('Security Gate') {
            steps {
                script {
                    def scanId = sh(script: "cat scan_response.json | jq -r '.scan_id'", returnStdout: true).trim()
                    echo "üîç Starting Security Gate for Scan ID: ${scanId}"
                    
                    sh """
                        STATUS="pending"
                        LAST_STATUS=""
                        
                        # Poll indefinitely
                        while [[ "\$STATUS" == "pending" || "\$STATUS" == "processing" || "\$STATUS" == "uploaded" || "\$STATUS" == "scanning" || "\$STATUS" == "analyzing" ]]; do
                            sleep 10
                            RESPONSE=\$(curl -s -X GET ${AI_BRAIN_URL}/scan_status/${scanId} -H "X-API-Key: ${AI_API_KEY}")
                            STATUS=\$(echo \$RESPONSE | jq -r '.status')
                            
                            if [[ "\$STATUS" != "\$LAST_STATUS" ]]; then
                                echo "Current Status: \$STATUS"
                                LAST_STATUS="\$STATUS"
                            fi
                        done
                        
                        if [[ "\$STATUS" != "completed" ]]; then
                            echo "‚ùå Scan Failed!"
                            exit 1
                        fi
                        echo "‚úÖ Security Gate Passed."
                        
                        # 3. Check for Blocking Issues
                        RISK_SCORE=\$(echo \$RESPONSE | jq -r '.risk_score')
                        echo "Final Risk Score: \$RISK_SCORE"
                    """
                }
            }
        }
        stage('Background Quality Audit') {
            steps {
                // Slower tools run here without blocking the AI-initiated commit/PR
                script {
                    sh "docker run --rm -v ${WORKSPACE}:/usr/src sonarsource/sonar-scanner-cli"
                }
            }
        }
    }
}
