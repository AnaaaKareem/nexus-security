pipeline {
    agent any
    stages {
        stage('AI Feed (Fast Scans)') {
            steps {
                script {
                    // 0. Start Application (Background)
                    sh """
                        if [ -f "start.sh" ]; then
                            chmod +x start.sh
                            ./start.sh > app.log 2>&1 &
                            echo "Waiting for app to launch..."
                            sleep 15
                        else
                            echo "âš ï¸ No start.sh found. DAST might fail if port 80 is closed."
                        fi
                    """
                }

                parallel(
                    "SAST": { sh "docker run --rm -v ${WORKSPACE}:/src semgrep/semgrep semgrep scan --config=auto --sarif --quiet -o semgrep.sarif" },
                    "Secrets": { sh "docker run --rm -v ${WORKSPACE}:/path zricethezav/gitleaks:latest detect --source='/path' --report-path='/path/gitleaks.json' --no-banner --exit-code=0" },
                    "IaC": { sh "docker run --rm -v ${WORKSPACE}:/tf bridgecrew/checkov:latest -d /tf --output sarif --quiet --soft-fail > checkov.sarif" },
                    "SCA": { sh "docker run --rm -v ${WORKSPACE}:/root/ aquasec/trivy:latest fs /root/ --format sarif --output trivy.sarif" },
                    "DAST": { sh "docker run --rm -v ${WORKSPACE}:/zap/wrk/:/zap/wrk/ --network=host -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://localhost:80 -J z.json || true" }
                )

                // Trigger AI Brain immediately
                sh """
                    FILES_TO_SEND=""
                    for report in semgrep.sarif checkov.sarif trivy.sarif gitleaks.json z.json; do
                        if [ -f "\$report" ]; then
                            FILES_TO_SEND="\$FILES_TO_SEND -F files=@\$report"
                        fi
                    done

                    if [ -n "\$FILES_TO_SEND" ]; then
                        echo "ðŸš€ Sending findings to AI Brain..."
                        curl -s -X POST ${AI_BRAIN_URL}/triage \
                            -H "Authorization: Bearer ${AI_API_KEY}" \
                            -F "project=${JOB_NAME}" \
                            -F "commit_sha=${GIT_COMMIT}" \
                            -F "branch=${BRANCH_NAME}" \
                            -F "event_name=push" \
                            -F "run_id=${BUILD_ID}" \
                            \$FILES_TO_SEND > ai_response.json
                    else
                        echo '{"status": "no_reports"}' > ai_response.json
                    fi
                    
                    echo "=== AI MODEL RESPONSE ==="
                    cat ai_response.json
                """
                archiveArtifacts artifacts: 'semgrep.sarif, gitleaks.json, checkov.sarif, trivy.sarif, z.json, ai_response.json', allowEmptyArchive: true
            }
        }
        stage('Background Quality Audit') {
            steps {
                // Slower tools run here without blocking the AI-initiated commit/PR
                script {
                    sh "docker run --rm -v ${WORKSPACE}:/usr/src sonarsource/sonar-scanner-cli"
                }
            }
        }
    }
}